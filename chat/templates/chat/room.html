{% extends 'chat/base.html' %}
{% load static %}

{% block title %}{{ room.title }} | Orgachat{% endblock title %}

{% block description %}Chat with your friends at Orgachat, {{ room.title }}{% endblock description %}

{% block content %}
<link rel="stylesheet" href="{% static 'chat/css/room.css' %}">
<script src="{% static 'chat/js/room.js' %}"></script>

<audio id="notification_sound">
    <source src="{% static 'chat/data/notification.flac' %}" type="audio/flac">
    Your browser does not support the audio element.
</audio>

<div class="container">
    <div class="messages">
        {% for message in room_messages %}
        <div class="message {% if message.user == user %} self{% else %} other{% endif %}" data-id="{{ message.id }}">
            {% if message.user == user %}
            <p>You{% else %}{{ message.user }}{% endif %} &mdash; {{ message.area.title }}</p>
            <p>{{ message.content }}</p>
        </div>
        {% endfor %}
    </div>
</div>

<div class="page-wrapper chiller-theme">
    <a id="show-sidebar" class="btn btn-sm btn-dark" href="#">
        <i class="fas fa-bars"></i>
    </a>
    <nav id="sidebar" class="sidebar-wrapper">
        <div class="sidebar-content">
            <div class="sidebar-brand">
                <a href="#" class="btn text-white">Areas</a>
                <div id="close-sidebar">
                    <i class="fas fa-times text-white"></i>
                </div>
            </div>
            <!-- sidebar-header  -->
            <div class="areas-all">
                <ul>
                    <li><a href="{% url 'chat:room' room.id %}">All</a></li>
                    {% for area in room.area_set.all %}
                    <li>
                        <a href="{% url 'chat:room' room.id %}?area_id={{ area.id }}">{{ area.title }}</a>
                        {% if user in area.star_users.all %}
                        <a href="{% url 'chat:star_area' area.id %}" class="float-right mr-4" style="color: #EBC12C"><i
                                class="fas fa-star"></i></a>
                        {% else %}
                        <a href="{% url 'chat:star_area' area.id %}" class="float-right mr-4 text-muted"><i
                                class="far fa-star"></i></a>
                        {% endif %}
                        {% if user in area.muted_users.all %}
                        <a href="{% url 'chat:mute_area' area.id %}" class="float-right mr-4 text-muted"><i
                                class="fas fa-volume-mute"></i> Unmute</a>
                        {% else %}
                        <a href="{% url 'chat:mute_area' area.id %}" class="float-right mr-4"><i
                                class="fas fa-volume-up"></i> Mute</a>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="area-add">
                <div class="">
                    <a href="{% url 'home' %}" class="btn text-white"><img src="{% static 'chat/img/favicon.png' %}">
                        Orgachat</a>
                    <a href="{% url 'home' %}" class="btn text-white float-right mr-4"><i class="fas fa-users"></i>
                        Users</a>
                </div>
                <form action="{% url 'chat:create_area' room.id %}" method="POST">
                    {% csrf_token %}
                    <input type="text" name="title" id="id_title" placeholder="Add area" required maxlength="30">
                    <button type="submit" class="btn" style="vertical-align: middle; margin-top: -5px;"><i
                            class="fas fa-plus-circle" style="font-size: 200%; color: #4CD137;"></i></button>
                </form>
            </div>
    </nav>
    <!-- sidebar-wrapper  -->

    <div class="send-message">
        <form action="{% url 'chat:room' room.id %}" method="post" class="form-inline">
            {% csrf_token %}
            <input type="text" name="content" id="id_content" class="form-control" placeholder="Type your message"
                required>
            <div class="message-options">
                <select name="area" id="id_area">
                    {% for area in room.area_set.all %}
                    <option value="{{ area.id }}">{{ area.title }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-success" id="sendMessage"><i
                        class="fas fa-paper-plane"></i></button>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelector('#sendMessage').onclick = function (e) {
                e.preventDefault();
                if (document.querySelector('#id_content').value == '' || !document.querySelector(
                        '#id_content').value) {
                    return false
                } else {
                    // ------------SEND AND MESSAGE---------------
                    let xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function (e) {
                        if (this.readyState == 4 && this.status == 200) {
                            let content = document.querySelector('#id_content').value
                            document.querySelector('#id_content').value = '';
                            let areaDiv = document.getElementById('id_area')
                            let area = areaDiv.options[areaDiv.selectedIndex].text
                            let lastId = parseInt(document.querySelectorAll('.message')[document
                                .querySelectorAll('.message').length - 1].getAttribute(
                                'data-id'))
                            document.querySelector('.messages').innerHTML += `
            <div class="message self" data-id=${lastId+1}>
            <p>You &mdash; ${area}:</p>
            <p>${content}</p>
        </div>
            `
                            document.querySelector('#notification_sound').play()
                        }
                    }
                    xhr.open("POST", "{% url 'chat:room' room.id %}", true);
                    xhr.setRequestHeader('Content-type', "application/x-www-form-urlencoded");
                    xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
                    data = {
                        'content': document.querySelector('#id_content').value,
                        'area': parseInt(document.querySelector('#id_area').value),
                    }
                    xhr.send(JSON.stringify(data));
                }
            }
            // -------------LOAD NEW MESSAGES-----------------
            var xhrLoad = new XMLHttpRequest();
            xhrLoad.onreadystatechange = function (e) {
                if (this.readyState == 4 && this.status == 200) {
                    let response = JSON.parse(this.responseText);
                    let newMessages = response.new_messages
                    if (!newMessages || newMessages.length <= 0) {
                        return false
                    } else {
                        for (message of newMessages) {
                            document.querySelector('.messages').innerHTML += `
                        <div class="message other" data-id="${message.id}">
            <p>${message.user} &mdash;${message.area}:</p>
            <p>${message.content}</p>
        </div>
                        `
                            document.querySelector('#notification_sound').play()
                        }
                    }
                };
            };
            setInterval(() => {
                xhrLoad.open('POST', "{% url 'chat:load_messages' room.id %}", true)
                xhrLoad.setRequestHeader('Content-type', "application/x-www-form-urlencode");
                xhrLoad.setRequestHeader('X-CSRFToken', '{{ csrf_token }}')
                let dataLoad = {
                    'last_id': parseInt(document.querySelectorAll('.message')[document
                        .querySelectorAll(
                            '.message').length - 1].getAttribute('data-id')),
                };

                xhrLoad.send(JSON.stringify(dataLoad))
            }, 3000)
        });
    </script>
</div>
{% endblock content %}