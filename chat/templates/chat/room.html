{% extends 'chat/base.html' %}
{% load static %}

{% block title %}{{ room.title }} | Orgachat{% endblock title %}

{% block description %}Chat with your friends at Orgachat, {{ room.title }}{% endblock description %}

{% block content %}
<link rel="stylesheet" href="{% static 'chat/css/room.css' %}">
<script src="{% static 'chat/js/room.js' %}"></script>

<audio id="notification_sound">
    <source src="{% static 'chat/data/notification.wav' %}" type="audio/wav">
    <source src="{% static 'chat/data/notification.ogg' %}" type="audio/ogg">
    <source src="{% static 'chat/data/notification.mpeg' %}" type="audio/mpeg">
    Your browser does not support the audio element.
</audio>

<div class="container">
    <div class="messages">
        {% for message in room_messages %}
        <div class="message {% if message.user == user %} self{% else %} other{% endif %}">
            {% if message.user == user %}
            <p>You{% else %}{{ message.user }}{% endif %} &mdash; {{ message.area.title }}</p>
            <p>{{ message.content }}</p>
        </div>
        {% endfor %}
    </div>
</div>

<div class="page-wrapper chiller-theme">
    <a id="show-sidebar" class="btn btn-sm btn-dark" href="#">
        <i class="fas fa-bars"></i>
    </a>
    <nav id="sidebar" class="sidebar-wrapper">
        <div class="sidebar-content">
            <div class="sidebar-brand">
                <a href="#" class="btn text-white">Areas</a>
                <div id="close-sidebar">
                    <i class="fas fa-times text-white"></i>
                </div>
            </div>
            <!-- sidebar-header  -->
            <div class="areas-all">
                <ul>
                    <li><a href="{% url 'chat:room' room.id %}">All</a></li>
                    {% for area in room.area_set.all %}
                    <li>
                        <a href="{% url 'chat:room' room.id %}?area_id={{ area.id }}">{{ area.title }}</a>
                        {% if user in area.star_users.all %}
                        <a href="{% url 'chat:star_area' area.id %}" class="float-right mr-4" style="color: #EBC12C"><i
                                class="fas fa-star"></i></a>
                        {% else %}
                        <a href="{% url 'chat:star_area' area.id %}" class="float-right mr-4 text-muted"><i
                                class="far fa-star"></i></a>
                        {% endif %}
                        {% if user in area.muted_users.all %}
                        <a href="{% url 'chat:mute_area' area.id %}" class="float-right mr-4 text-muted"><i
                                class="fas fa-volume-mute"></i> Unmute</a>
                        {% else %}
                        <a href="{% url 'chat:mute_area' area.id %}" class="float-right mr-4"><i
                                class="fas fa-volume-up"></i> Mute</a>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="area-add">
                <div class="">
                    <a href="{% url 'home' %}" class="btn text-white"><img src="{% static 'chat/img/favicon.png' %}">
                        Orgachat</a>
                    <a href="{% url 'home' %}" class="btn text-white float-right mr-4"><i class="fas fa-users"></i>
                        Users</a>
                </div>
                <form action="{% url 'chat:create_area' room.id %}" method="POST">
                    {% csrf_token %}
                    <input type="text" name="title" id="id_title" placeholder="Add area" required maxlength="30">
                    <button type="submit" class="btn" style="vertical-align: middle; margin-top: -5px;"><i
                            class="fas fa-plus-circle" style="font-size: 200%; color: #4CD137;"></i></button>
                </form>
            </div>
    </nav>
    <!-- sidebar-wrapper  -->

    <div class="send-message">
        <form action="{% url 'chat:room' room.id %}" method="post" class="form-inline">
            {% csrf_token %}
            <input type="text" name="content" id="id_content" class="form-control" placeholder="Type your message"
                required>
            <div class="message-options">
                <select name="area" id="id_area">
                    {% for area in room.area_set.all %}
                    <option value="{{ area.id }}">{{ area.title }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-success" id="sendMessage"><i
                        class="fas fa-paper-plane"></i></button>
            </div>
        </form>
    </div>

    <script>
        // -------------------
        // WEBSOCKET SETUP
        // -------------------
        var wsStart = 'ws://'
        var hostName = window.location.hostname + ':8000'
        if (window.location.protocol.includes('https')) {
            wsStart = 'wss://'
            hostName = window.location.hostname
        };
        let endpoint = wsStart + hostName + '/ws' + window.location.pathname
        console.log(endpoint)
        var socket = new WebSocket(endpoint);

        socket.onmessage = function (e) {
            // todo not show message if in a different room
            data = JSON.parse(e.data);
            console.log(data.area_id)
            console.log(data.area)
            var sender = 'other'
            var username = data.username
            if (data.username == "{{ user.username }}") {
                sender = 'self';
                username = 'You'
            }
            document.querySelector('.messages').innerHTML += `
            <div class="message ${sender}">
            <p>${username} &mdash; ${data.area}:</p>
            <p>${data.content}</p>
        </div>
            `
            document.querySelector('#notification_sound').play()
        }
        socket.onerror = function (e) {
            alert("SERVER ERROR 500, You won't be able to see messages unless you refresh,")
        }
        socket.onclose = function (e) {}

        document.addEventListener('DOMContentLoaded', function () {
            document.querySelector('#sendMessage').onclick = function (e) {
                e.preventDefault();
                // ------------AJAX: SEND AND MESSAGE---------------
                let xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function (e) {
                    if (this.readyState == 4 && this.status == 200) {
                        document.querySelector('#id_content').value = '';
                    }
                }
                xhr.open("POST", "{% url 'chat:room' room.id %}", true);
                xhr.setRequestHeader('Content-type', "application/x-www-form-urlencoded");
                data = {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'content': document.querySelector('#id_content').value,
                    'area': parseInt(document.querySelector('#id_area').value),
                }
                xhr.send(JSON.stringify(data));

                // ---------------WEBSOCKET: ECHO MESSAGE---------------
                let area = document.getElementById('id_area')
                socket.send(JSON.stringify({
                    'content': document.querySelector('#id_content').value,
                    'area': area.options[area.selectedIndex].text,
                    'area_id': document.querySelector('#id_area').value
                }));
            }
        });
    </script>
    {% endblock content %}