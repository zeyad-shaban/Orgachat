{% extends 'chat/base.html' %}
{% load static %}

{% block title %}Home | Orgachat{% endblock title %}

{% block description %}Have an organized chat with your friends.{% endblock description %}

{% block content %}

<!-- -------------------New users with no chats------------------- -->
{% if general_rooms.count <= 0 and user.homepagearea_set.count <= 0%}
<section>
    <p>Find and add your friends <a href="{% url 'users:all_users' %}" target="_blank"> Here</a></p>
    <p>Click on the three dots in the navbar to: Install the app, Add Groups, Divide homepage using Homepage Areas,
        and much others</p>
    <p>Check your profile <a href="{% url 'users:profile' %}">Here</a> and update your profile and privacy</p>
    <p>We will send you messages through email to keep you updated, if you want to disable this feature reply with
        "No" or "Unsubscribe"</p>
    <small class="form-text text-muted">You are seeing this because you don't have chat rooms</small>
</section>
{% endif %}
<!-- -------------------End new users with no chats------------------- -->

<!-- -------------------Homepage Areas------------------- -->
{% for area in user.homepagearea_set.all %}
<div class="accordion">
    <div class="card">
        <div class="card-header">
            <button class="btn btn-link btn-block" onclick="toggleCollapse('#area{{area.id}}')">
                {{area.title}} <a href="#" type="button" class="badge badge-danger ml-3">{{area.unread_count}}</a>
            </button>
        </div>

        <div id="area{{area.id}}" class="collapse">
            {% if area.room_set.count <= 0 %}
            <p>Hold the chat room you want to add here. This area is currently Empty</p>
            {% endif %}
            <div id="chatbox">
                {% for room in area.room_set.all %}
                <a href="{% url 'chat:room' room.id %}" id="openRoom{{room.id}}">
                    <div class="friend" onclick="document.querySelector('#openRoom{{room.id}}').click()"
                        data-id="{{room.id}}">
                        <img src="{{room.imageURL}}" loading="lazy" width="50" height="50" />
                        <a href="#" type="button" style="font-size: 120%"
                            class="badge badge-danger mt-4">{% if room.unread_count > 0 %}{{room.unread_count}}{% endif %}</a>
                        <p>
                            <strong>{{room.title}} {% if room.type == "group" %} &mdash; <i class="fas fa-users"></i>
                                {% endif %}</strong>
                            <br>
                            <span>{{room.last_message}}</span>
                        </p>
                    </div>
                </a>
                <br>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endfor %}
<!-- -------------End Homepage Areas------------- -->

<!-- -------------general Areas------------- -->

<!-- -------------End general Areas------------- -->
<div class="accordion">
    <div class="card">
        <div class="card-header">
            <button class="btn btn-link btn-block" onclick="toggleCollapse('#areaothers')">
                general <a href="#" type="button" class="badge badge-danger ml-3">{{general_count}}</a>
            </button>
        </div>

        <div id="areaothers" class="{% if user.homepagearea_set.count > 0 %}collapse{% endif %}">
            <div id="chatbox">
                {% if general_rooms.count <= 0 %}
                <p>Hold the chat room you want to add here. This area is currently Empty</p>
                {% endif %}
                {% for room in general_rooms %}
                <a href="{% url 'chat:room' room.id %}" id="openRoom{{room.id}}">
                    <div class="friend" onclick="document.querySelector('#openRoom{{room.id}}').click()"
                        data-id="{{room.id}}">
                        <img src="{{room.imageURL}}" loading="lazy" width="50" height="50" />
                        <a href="#" type="button" style="font-size: 120%"
                            class="badge badge-danger mt-4">{% if room.unread_count > 0 %}{{room.unread_count}}{% endif %}</a>
                        <p>
                            <strong>{{room.title}} {% if room.type == "group" %} &mdash; <i class="fas fa-users"></i>
                                {% endif %}</strong>
                            <span>{{room.last_message}}</span>
                        </p>
                    </div>
                </a>
                <br>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
<button class="btn btn-circle" id="extrasBtn" onclick="openModal('#extras')"><i
        class="fas fa-comment-dots"></i></button>

<!-- ------------------------------------ -->
<!-- Modals -->
<!-- ------------------------------------ -->

<!-- --------------------------Extras-------------------------- -->
<div class="modal fade" id="extras" tabindex="-1" role="dialog" aria-labelledby="extrasLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #4CD137">
                <button class="btn btn-outline-secondary text-white btn-circle" onclick="closeModal('#extras')"><i
                        class="fas fa-arrow-left"></i></button>
            </div>
            <div class="modal-body">
                <button class="btn" onclick="openModal('#addGroup')"><i
                        class="fas fa-user-friends btn btn-success btn-circle p-2 i-md"></i>&nbsp; New group</button>
                <br>
                <button class="btn" onclick="openModal('#addArea')"><i
                        class="fas fa-chart-pie btn btn-success btn-circle p-2 i-md"></i>&nbsp; New divider</button> <i
                    class="fas fa-question-circle" onclick="toast('divides your homepage')"></i>
                <hr>

                <a type="button" href="{% url 'users:all_users' %}" class="btn"><i
                        class="fas fa-user-plus btn btn-success btn-circle p-2 i-md"></i>&nbsp; Add user</a>
                <!-- AddToAny BEGIN -->
                <div class="a2a_kit a2a_kit_size_32 a2a_default_style"
                    data-a2a-url="https://orgachat.com/users/add-friend/{{user.id}}/?utm_source=orgachat&amp;utm_medium=referral&amp;utm_campaign=invite_friend"
                    data-a2a-title="Orgachat Friend Invitation link">
                    <button class="btn">
                        <a class="a2a_dd btn btn-success btn-circle p-2" id="profile-page"
                            href="https://www.addtoany.com/share"></a> &nbsp; Invite
                        friends
                    </button>
                </div>
                <script>
                    var a2a_config = a2a_config || {};
                    a2a_config.onclick = 1;
                </script>
                <script async src="https://static.addtoany.com/menu/page.js"></script>
                <!-- AddToAny END -->
            </div>
        </div>
    </div>
</div>
<!-- --------------------------Add Area-------------------------- -->
<div class="modal fade" id="addArea" tabindex="-1" role="dialog" aria-labelledby="addAreaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <div class="center">
                    <h2 class="modal-title" id="addAreaLabel">New divider</h2>
                </div>
                <button type="button" class="close" onclick="closeModal('#addArea')">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form action="{% url 'chat:create_homepage_area' %}" method="POST">
                    {% csrf_token %}
                    <input type="text" name="title" id="id_title" placeholder="title" required
                        maxlength="50" class="from-control">
                    <button type="submit" class="btn btn-success"><i class="fas fa-plus"></i></button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ---------Add Group---------- -->
<div class="modal fade" id="addGroup" tabindex="-1" role="dialog" aria-labelledby="addGroupLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addGroupLabel">New Group</h5>
                <button type="button" class="close" onclick="closeModal('#addGroup')">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form action="{% url 'chat:create_group' %}" method="post">
                    {% csrf_token %}
                    <input type="text" name="name" id="id_name" placeholder="title" required maxlength="50"
                        class="from-control">
                    <button type="submit" class="btn btn-success"><i class="fas fa-plus"></i></button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- -------------Edit on a chat room-------------- -->
<div class="modal fade" id="editRoom" tabindex="-1" role="dialog" aria-labelledby="editRoomLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div class="center">
                    <h2 class="modal-title" id="editRoomLabel">Edit Chat Room</h2>
                </div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"
                    onclick="closeModal('#editRoom')">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="center">
                    <h2>Homepage Area</h2>
                </div>

                {% for area in user.homepagearea_set.all %}
                <p class="float-left">{{area.title}}</p>
                <a href="{% url 'chat:move_room' area.id %}" class="btn btn-outline-success ml-3 btn-sm moveRoomBtn"><i
                        class="fas fa-plane"></i> Move</a>
                <br>
                <br>
                {% endfor %}
                <p class="float-left">general</p>
                <a href="{% url 'chat:move_room' 0 %}" class="btn btn-outline-success ml-3 btn-sm moveRoomBtn"><i
                        class="fas fa-plane"></i> Move</a>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="{% static 'chat/css/home.css' %}">
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var longpress = false;
        var presstimer = null;
        var longtarget = null;
        var cancel = function (e) {
            if (presstimer !== null) {
                clearTimeout(presstimer);
                presstimer = null;
            }

            this.classList.remove("longpress");
        };

        var click = function (e) {
            if (presstimer !== null) {
                clearTimeout(presstimer);
                presstimer = null;
            }

            this.classList.remove("longpress");

            if (longpress) {
                return false;
            }
        };

        var start = function (e) {

            if (e.type === "click" && e.button !== 0) {
                return;
            }

            longpress = false;

            this.classList.add("longpress");

            if (presstimer === null) {
                roomId = this.getAttribute("data-id")
                presstimer = setTimeout(function () {
                    openModal("#editRoom")
                    longpress = true;
                }, 1000);
            }

            return false;
        };
        var roomId = 1;
        var rooms = document.querySelectorAll('.friend')

        function addHoldListener(node) {
            node.addEventListener("mousedown", start);
            node.addEventListener("touchstart", start);
            node.addEventListener("click", click);
            node.addEventListener("mouseout", cancel);
            node.addEventListener("touchend", cancel);
            node.addEventListener("touchleave", cancel);
            node.addEventListener("touchcancel", cancel);
        }
        for (room of rooms) {
            addHoldListener(room)
        }

        // Move Room
        var moveBtns = document.querySelectorAll(".moveRoomBtn")
        for (btn of moveBtns) {
            btn.onclick = function (e) {
                e.preventDefault()
                var xhr = new XMLHttpRequest()
                xhr.onreadystatechange = function (e) {
                    if (this.readyState == 4 && this.status == 200) {
                        toast("Please refresh to see changes")
                    }
                }
                xhr.open("POST", this.getAttribute("href"), true)
                let data = {
                    "room_id": roomId,
                };
                xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
                xhr.setRequestHeader("X-CSRFToken", "{{csrf_token}}")
                xhr.send(JSON.stringify(data))
            }
        }
    });
</script>

<!-- ----------------------Show Latest updates to user------------------ -->
<div class="modal fade" id="latestUpdate" tabindex="-1" role="dialog" aria-labelledby="latestUpdateLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #ff0000;">
                <div class="center">
                    <h3 class="modal-title" id="latestUpdateLabel"><img src="{% static 'chat/img/favicon.png' %}"
                            width="50" height="50" alt=""> IMPORTANT BIG UPDATE!</h3>
                </div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"
                    onclick="closeModal('#latestUpdate')">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <div class="center">
                        <div class="center">
                            <h2>Notifications</h2>
                        </div>
                    </div>
                    <p>Notifications are finally working, no longer beta!</p>
                    <p>How to activate?</p>
                    <p>1- Click on the three dots</p>
                    <p>2- Install the app from the "Install Orgachat" button (If you faced errors read the intructions
                        in it)</p>
                    <div class="alert alert-danger">If you previously installed it considered reinstalling it as there
                        were some issues with the previous one, thanks for understanding
                        <br>
                        إذا قمت بتثبيته مسبقًا ، فقم بإعادة تثبيته نظرًا لوجود بعض المشكلات في الإصدار السابق ، شكرًا
                        لتفهمك
                    </div>
                    <p>3- Open Orgachat after installed it, click on the three dots again, then click on "Subscribe to
                        push message",
                        wait a little and it should change to "Unsubscribe to..." If so happened you are good to go (If
                        it didn't refresh the page and see if the text changed)</p>
                    <p>Note that the subscription is based on device not account</p>
                    <h4>Facing Trouble:</h4>
                    <p>If the button is disabled but the content didn't change from "Subscribe" to "Unsubscribe" this
                        means that your browser blocked the website notifications.</p>
                    <p> To fix open the app from your browser => click on the lock icon beside the url => you should see
                        that the notifications permession is blocked, change that to "allow" or "ask (default)"</p>
                    <p>Didn't solve the problem? <a href="https://www.orgachat.com/users/view/2/"
                            target="_blank">Contact us here</a>
                    </p>
                    <!-- <a href="#" target="_blank">Our explainer video</a> -->
                    <br>
                    <div class="center">
                        <h2>Offline support</h2>
                    </div>
                    <p>Don't worry, it won't cause the app to crash as in the last time 😂</p>
                    <p>Note that there are only four pages with offline support for now: Home page, Profile page, all
                        users page, and about page. Any page else will crash if you are not connected to internet</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal"
                    onclick="closeModal('#latestUpdate')">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        function createCookie(name, value, days) {
            if (days) {
                var date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                var expires = "; expires=" + date.toGMTString();
            } else var expires = "";
            document.cookie = name + "=" + value + expires + "; path=/";
        }

        function readCookie(name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function eraseCookie(name) {
            createCookie(name, "", -1);
        }
        if (!readCookie('alreadyShown2')) {
            openModal('#latestUpdate')
            createCookie('alreadyShown2', true)
        }
    });
</script>
{% endblock content %}